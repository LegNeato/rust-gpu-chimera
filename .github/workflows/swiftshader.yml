name: SwiftShader

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  RUST_BACKTRACE: 1

jobs:
  macos-wgpu:
    name: macOS SwiftShader (wgpu)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install SwiftShader
        uses: GDRETools/gdsdecomp/.github/actions/install-swiftshader@master
        with:
          install_swiftshader: true

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run the demo (wgpu)
        # SwiftShader ICD uses relative paths, so we must run from workspace root
        working-directory: ${{ github.workspace }}
        run: cargo run --release --features wgpu,vulkan

      - name: Run unit tests (wgpu)
        working-directory: ${{ github.workspace }}
        run: cargo test --release --features wgpu,vulkan

  macos-ash:
    name: macOS SwiftShader (ash)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install SwiftShader
        uses: GDRETools/gdsdecomp/.github/actions/install-swiftshader@master
        with:
          install_swiftshader: true

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run the demo (ash)
        working-directory: ${{ github.workspace }}
        run: cargo run --release --features ash

      - name: Run unit tests (ash)
        working-directory: ${{ github.workspace }}
        run: cargo test --release --features ash

  windows-wgpu:
    name: Windows SwiftShader (wgpu)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install SwiftShader
        uses: GDRETools/gdsdecomp/.github/actions/install-swiftshader@master
        with:
          install_swiftshader: true

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run the demo (wgpu)
        working-directory: ${{ github.workspace }}
        run: cargo run --release --features wgpu,vulkan

      - name: Run unit tests (wgpu)
        working-directory: ${{ github.workspace }}
        run: cargo test --release --features wgpu,vulkan

  windows-ash:
    name: Windows SwiftShader (ash)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install SwiftShader
        uses: GDRETools/gdsdecomp/.github/actions/install-swiftshader@master
        with:
          install_swiftshader: true

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run the demo (ash)
        working-directory: ${{ github.workspace }}
        run: cargo run --release --features ash

      - name: Run unit tests (ash)
        working-directory: ${{ github.workspace }}
        run: cargo test --release --features ash